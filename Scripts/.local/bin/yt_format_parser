#!/bin/sh
# Generic YouTube link handler depends on yt-dlp and fzf, and uses invidious to get the video

menu() {
	fzfmenu.sh
}

link="$(printf %s "$1" | sed "s#www.youtube.com#farside.link/invidious#")"
video_options="$(yt-dlp -q -F "$1" | grep webm_dash | grep "video only")"
prechoice="$(printf %s "$video_options" | awk '{print $14}' | sed "s/,//g" | sed "/.*144p.*/d")"

if [ -z "$prechoice" ]; then
	exit 1
fi

choice="$(printf "%s\nAudio\nBest" "$prechoice" | menu)"

if [ -z "$choice" ]; then
	exit 1
fi

case "$choice" in
	"Best")
		mpv --ytdl-format=best "$link" --really-quiet --no-terminal
		;;
	"Audio")
		mpv --ytdl-format=bestaudio "$link" --really-quiet --no-terminal --force-window
		;;
	*)
		code="$(printf '%s' "$video_options" | grep "\b$choice\b" | awk '{print $1}')"
		mpv --ytdl-format="$code"+bestaudio "$link" --really-quiet --no-terminal
		;;
esac
