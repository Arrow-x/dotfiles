#!/bin/bash

ueberzugpp layer --no-stdin --silent &
UB_PID=$!

# sleep some time for U++ startup
sleep 0.2

export SOCKET=/tmp/ueberzugpp-$UB_PID.socket


imgs(){
	fzf --preview='ueberzugpp cmd -s $SOCKET -a add -x $(expr $FZF_PREVIEW_COLUMNS + 6) -y 1 --max-width $FZF_PREVIEW_COLUMNS --max-height $FZF_PREVIEW_LINES -f {}' --bind "ctrl-l:execute($IMAGE -- {} &)" --header 'CTRL-l to open without closing' --reverse "$@"
}

dirs(){
	fzf --preview-window wrap --preview='ueberzugpp cmd -s $SOCKET -a add -x $(expr $FZF_PREVIEW_COLUMNS + 6) -y 1 --max-width $FZF_PREVIEW_COLUMNS --max-height $FZF_PREVIEW_LINES \
		-f {}/"$(ls {} | head -n 1)"' --bind "ctrl-l:execute($IMAGE -- {} &)" --header 'CTRL-l to open without closing' --print0 
}

# TODO: Auto detect if file or dir are passed
# TODO: add docs and a help option
case "$1" in
	-d) dirs;;
	-f) imgs;;
	*) exit 1
esac

kill -TERM $UB_PID
