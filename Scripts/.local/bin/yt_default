#!/bin/sh

link="$1"
threads=4

menu() {
	fzfmenu.sh
}

choice="$(printf "720p\n720p60\nAudio\n" | menu)"

[ -z "$choice" ] && exit 1

try_audio() {
	rm -rf "/tmp/cantgetaudio"
	if ! yt-dlp --quiet -N $threads --no-part -f "ba" "$link" -o /tmp/ytaudio; then
		notify-send -u low -i /usr/share/icons/Qogir/32/status/dialog-error.svg "No Audio"
		touch "/tmp/cantgetaudio"
	fi
}

check_audio() {
	file_path="/tmp/ytaudio"
	timeout_seconds=300
	check_interval=1
	start_time=$(date +%s)
	elapsed=0

	while [ ! -f "$file_path" ]; do
		if [ -f "/tmp/cantgetaudio" ]; then
			rm -rf "/tmp/cantgetaudio"
			return 1
		fi

		if [ "$timeout_seconds" -gt 0 ] && [ "$elapsed" -ge "$timeout_seconds" ]; then
			notify-send -u low -i /usr/share/icons/Qogir/32/status/dialog-error.svg "Timout reached while waiting "
			return 1
		fi
		sleep $check_interval
		elapsed=$(($(date +%s) - start_time))
	done
	return 0
}


clean_exit() {
	rm -rf /tmp/ytaudio*
	rm -rf "/tmp/cantgetaudio"
	exit "$1"
}

get_audio() {
	try_audio &
	if ! check_audio; then
		clean_exit 1
	fi
}

case "$choice" in
	"Audio")
		yt-dlp --quiet -N $threads --no-part -f "bestaudio" "$link" -o - | mpv --really-quiet --no-terminal --force-window -
		;;
	"720p")
		get_audio
		if ! yt-dlp --quiet -N $threads --no-part -f "bv[height<=720] [fps<=30]" "$link" -o - | mpv --audio-file="/tmp/ytaudio" --really-quiet --no-terminal --force-window -; then
			clean_exit 1
		fi
		clean_exit 0
		;;
	"720p60")
		get_audio
		if ! yt-dlp --quiet -N $threads --no-part -f "bv[height<=720] [fps<=60]" "$link" -o - | mpv --audio-file="/tmp/ytaudio" --really-quiet --no-terminal --force-window -; then
			clean_exit 1
		fi
		clean_exit 0
		;;
esac
