#!/bin/sh

pid_file="/tmp/.$(uuidgen)"
case "$TERM" in
	"xterm-256color" | "foot" | "tmux-256color") ueberzugpp layer --no-cache --no-stdin --silent --output sixel --pid-file "$pid_file" ;;
	"xterm-kitty") ueberzugpp layer --no-cache --no-stdin --silent --output kitty --pid-file "$pid_file" ;;
	*) ueberzugpp layer --no-cache --no-stdin --silent --use-escape-codes --pid-file "$pid_file" ;;
esac
UB_PID=$(cat "$pid_file")
export SOCKET=/tmp/ueberzugpp-"$UB_PID".socket
pics="/home/arrowx/Pictures/Wallpapers"
resault="$(find -L "$pics" -type f -printf "%T+ %p\n" | sort -r | sed "s#.*/home#/home#" | fzf \
	--preview-window='up,30' \
	--preview='ueberzugpp cmd -s $SOCKET -a add -x 1 -y 1 --max-width $FZF_PREVIEW_COLUMNS --max-height $FZF_PREVIEW_LINES -f {}' \
	--bind 'ctrl-l:execute(xdg-open {})' --bind 'ctrl-d:reload(trash {}; fd -t f -L -0 . $pics | xargs --null ls -t )' \
	--header "CTRL-d to Delete | CTRL-l to open without closing")"

ueberzugpp cmd -s "$SOCKET" -a exit
rm "$pid_file"

if [ -z "$resault" ]; then
	exit 2
fi
set_bg "$resault" >/dev/null
