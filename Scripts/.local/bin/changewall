#!/bin/bash
set -e
export FIFO_UEBERZUG="${TMPDIR:-/tmp}/wall-ueberzug-$$"

cleanup() {
      exec 3>&-
      rm "$FIFO_UEBERZUG"
    }

mkfifo "$FIFO_UEBERZUG"
ueberzug layer -s <"$FIFO_UEBERZUG" &
exec 3>"$FIFO_UEBERZUG"
trap cleanup EXIT

function preview() {
  path="$(printf '%s' "$5" | sed 's/\\/\\\\/g;s/"/\\"/g')" 
  printf '{"action": "add", "identifier": "preview", "x": %d, "y": %d, "width": %d, "height": %d, "scaler": "contain", "scaling_position_x": 0.5, "scaling_position_y": 0.5, "path": "%s"}\n' \
  "$1" "$2" "$3" "$4" "$5" >"$FIFO_UEBERZUG"
  exit 1
}

export -f preview
fd -t f -L -0 . ~/Pictures -E Vertical | xargs --null ls -t | fzf --preview-window='up,30' --preview='bash -c "preview  1 1 $FZF_PREVIEW_COLUMNS $FZF_PREVIEW_LINES {}"' | xargs -I _ nitrogen --set-zoom-fill --save _ >/dev/null 2>&1
