#!/bin/sh
# Generaic youtube link handeler depends on yt-dlp and dmenu, and uses invidious to get the video
# TODO: is this taking more or less time ?

link=$(printf %s "$1" | sed "s#www.youtube.com#farside.link/invidious#")
video_options=$(yt-dlp -F "$1" | grep webm_dash | grep "video only")
prechoice=$(printf %s "$video_options" | awk '{print $14}' | sed "s/,//g" | sed "/.*144p.*/d" )

if [ -z "$prechoice" ]; then
	exit 2
fi

choice=$(printf "Audio\n720pMP4\n%s" "$prechoice" | $MENU -p "Quality: ")

if [ -z "$choice" ]; then
	exit 2
fi

case "$choice" in
	"720pMP4")
		mpv --ytdl-format=22 "$link" --really-quiet --no-terminal & ;;
	"Audio")
		mpv --ytdl-format=bestaudio "$link" --really-quiet --no-terminal --force-window --no-video & ;;
	*)
		code=$(echo "$video_options" | grep "$choice" | awk '{print $1}')
		mpv --ytdl-format="$code"+bestaudio "$link" --really-quiet --no-terminal & ;;
esac
