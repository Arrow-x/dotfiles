#! /bin/sh

# Generaic youtube link handeler depends on yt-dlp and dmenu, and uses invidious to get the video
# TODO: is this taking more or less time ?

link=$(echo "$1" | sed "s#www.youtube.com#farside.link/invidious#")
video_options=$(yt-dlp -F "$1" | grep webm_dash | grep "video only")
prechoice=$(echo "$video_options" | awk '{print $14}' | sed "s/,//g" | sed "/.*144p.*/d" )

if [ -z "$prechoice" ]; then
	exit 128
fi

choice=$(echo -e "Audio\n" "720pMP4\n" "$prechoice" | dmenu)

if [ -z "$choice" ]; then
	exit 128

elif [ "$choice" = " 720pMP4" ]; then
	mpv --ytdl-format=22 "$link" --really-quiet --no-terminal &

elif [ "$choice" = "Audio" ]; then
	mpv --ytdl-format=bestaudio "$link" --really-quiet --no-terminal --force-window --no-video &

else
	CODE=$(echo "$video_options" | grep "$choice" | awk '{print $1}')
	mpv --ytdl-format="$CODE"+bestaudio "$link" --really-quiet --no-terminal &
fi
